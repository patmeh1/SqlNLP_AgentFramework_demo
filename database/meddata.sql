-- MedData Database Schema and Data Load Script
-- This script creates tables and loads data for the MedData database
-- Run this script after creating an Azure SQL Database called 'MedData'

-- ============================================================================
-- TABLE CREATION
-- ============================================================================

-- Create MED_SLOTS table
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'MED_SLOTS')
BEGIN
    CREATE TABLE MED_SLOTS (
        SLOT_NUMBER INT PRIMARY KEY,
        SLOT_NAME NVARCHAR(100) NOT NULL,
        SLOT_TYPE NVARCHAR(50) NOT NULL
    );
    PRINT 'MED_SLOTS table created';
END
ELSE
BEGIN
    PRINT 'MED_SLOTS table already exists';
END
GO

-- Create MED table with foreign key
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'MED')
BEGIN
    CREATE TABLE MED (
        ID INT IDENTITY(1,1) PRIMARY KEY,
        CODE INT NOT NULL,
        SLOT_NUMBER INT NOT NULL,
        SLOT_VALUE NVARCHAR(500),
        CONSTRAINT FK_MED_SLOTS FOREIGN KEY (SLOT_NUMBER) REFERENCES MED_SLOTS(SLOT_NUMBER)
    );
    
    -- Create indexes for better query performance
    CREATE INDEX IX_MED_CODE ON MED(CODE);
    CREATE INDEX IX_MED_SLOT_NUMBER ON MED(SLOT_NUMBER);
    
    PRINT 'MED table created with indexes';
END
ELSE
BEGIN
    PRINT 'MED table already exists';
END
GO

-- ============================================================================
-- DATA LOADING - MED_SLOTS
-- ============================================================================

PRINT 'Loading MED_SLOTS data...';

-- Clear existing data
DELETE FROM MED_SLOTS;

-- Insert slot definitions
INSERT INTO MED_SLOTS (SLOT_NUMBER, SLOT_NAME, SLOT_TYPE) VALUES
(3, 'DESCENDANT-OF', 'SEMANTIC'),
(4, 'SUBCLASS-OF', 'SEMANTIC'),
(6, 'PRINT-NAME', 'STRING'),
(9, 'CPMC-LAB-PROC-CODE', 'STRING'),
(15, 'MEASURED-BY-PROCEDURE', 'SEMANTIC'),
(16, 'ENTITY-MEASURED', 'SEMANTIC'),
(20, 'CPMC-LAB-TEST-CODE', 'STRING'),
(149, 'PT-PROBLEM-(INDICATED-BY)->PROCEDURE', 'SEMANTIC'),
(150, 'PROCEDURE-(INDICATES)->PT-PROBLEM', 'SEMANTIC'),
(212, 'LOINC-CODE', 'STRING'),
(264, 'MILLENNIUM-LAB-CODE', 'STRING'),
(266, 'SNOMED-CODE', 'STRING'),
(277, 'EPIC-COMPONENT-ID', 'STRING');

PRINT 'MED_SLOTS data loaded: ' + CAST(@@ROWCOUNT AS VARCHAR) + ' rows';
GO

-- ============================================================================
-- DATA LOADING - MED
-- ============================================================================

PRINT 'Loading MED data...';

-- Clear existing data
DELETE FROM MED;

-- Insert medical code data
INSERT INTO MED (CODE, SLOT_NUMBER, SLOT_VALUE) VALUES
-- Code 1302
(1302, 150, '19928'), (1302, 150, '3668'), (1302, 20, ''), (1302, 212, '2947-0'),
(1302, 266, ''), (1302, 277, ''), (1302, 3, '32180'), (1302, 4, '32180'),
(1302, 6, 'Stat Whole Blood Sodium Ion Measurement'),

-- Code 1611
(1611, 150, '19928'), (1611, 150, '3668'), (1611, 20, ''), (1611, 212, '2947-0'),
(1611, 266, ''), (1611, 277, ''), (1611, 3, '32180'), (1611, 4, '32180'),
(1611, 6, 'Presbyterian Whole Blood Sodium Ion Measurement'),

-- Code 1612
(1612, 150, '19928'), (1612, 150, '3668'), (1612, 20, ''), (1612, 212, '2951-2'),
(1612, 266, ''), (1612, 277, ''), (1612, 3, '32698'), (1612, 4, '32698'),
(1612, 6, 'Serum Sodium Ion Measurement'),

-- Code 1662
(1662, 150, '19928'), (1662, 150, '3668'), (1662, 20, ''), (1662, 212, ''),
(1662, 266, ''), (1662, 277, ''), (1662, 3, '32180'), (1662, 4, '32180'),
(1662, 6, 'Allen Whole Blood Sodium Ion Measurement'),

-- Code 3668
(3668, 266, '39355002'), (3668, 3, '42484'), (3668, 4, '42484'), (3668, 6, 'Hypernatremia'),

-- Code 3670
(3670, 266, '238115004'), (3670, 3, '19928'), (3670, 3, '42484'), (3670, 4, '19928'),
(3670, 6, 'True Sodium (Na) Deficiency'),

-- Code 19928
(19928, 266, '89627008'), (19928, 3, '42484'), (19928, 4, '42484'), (19928, 6, 'Hyponatremia'),

-- Code 32180
(32180, 150, '19928'), (32180, 150, '3668'), (32180, 212, ''), (32180, 266, ''),
(32180, 277, ''), (32180, 6, 'Whole Blood Sodium Tests'),

-- Code 32698
(32698, 150, '19928'), (32698, 150, '3668'), (32698, 212, ''), (32698, 266, ''),
(32698, 277, ''), (32698, 6, 'Serum Sodium Ion Tests'),

-- Code 32712
(32712, 150, '19928'), (32712, 150, '3668'), (32712, 20, ''), (32712, 212, '2951-2'),
(32712, 266, ''), (32712, 277, ''), (32712, 3, '32698'), (32712, 4, '32698'),
(32712, 6, 'Serum Sodium Ion Measurement 2'),

-- Code 35978
(35978, 150, '19928'), (35978, 150, '3668'), (35978, 20, 'INA'), (35978, 212, '2947-0'),
(35978, 266, ''), (35978, 277, ''), (35978, 3, '32180'), (35978, 4, '32180'),
(35978, 6, 'CPMC Laboratory Test: Sodium, Whole Blood'),

-- Code 36066
(36066, 150, '19928'), (36066, 150, '3668'), (36066, 20, 'NAWBZ'), (36066, 212, '2947-0'),
(36066, 266, ''), (36066, 277, ''), (36066, 3, '32180'), (36066, 4, '32180'),
(36066, 6, 'CPMC Laboratory Test: Sodium Whole Blood'),

-- Code 36067
(36067, 150, '19928'), (36067, 150, '3668'), (36067, 20, 'NAZ'), (36067, 212, '2951-2'),
(36067, 266, ''), (36067, 277, ''), (36067, 3, '32698'), (36067, 4, '32698'),
(36067, 6, 'CPMC Laboratory Test: Sodium'), (36067, 9, 'NAZ'),

-- Code 42484
(42484, 266, ''), (42484, 6, 'Abnormal Blood Level of Sodium'),

-- Code 50013
(50013, 150, '19928'), (50013, 150, '3668'), (50013, 212, '2951-2'), (50013, 266, ''),
(50013, 277, ''), (50013, 3, '32698'), (50013, 4, '32698'), (50013, 6, 'NYH Lab Procedure: Sodium'),

-- Code 50228
(50228, 150, '19928'), (50228, 150, '3668'), (50228, 212, ''), (50228, 266, ''),
(50228, 277, ''), (50228, 3, '32180'), (50228, 4, '32180'), (50228, 6, 'NYH Lab Procedure: Sodium , W/B'),

-- Code 56253
(56253, 150, '19928'), (56253, 150, '3668'), (56253, 20, 'SOD'), (56253, 212, '2951-2'),
(56253, 266, ''), (56253, 277, ''), (56253, 3, '32698'), (56253, 4, '32698'),
(56253, 6, 'CPMC Laboratory Test: Serum Sodium Measurement'), (56253, 9, 'SOD'),

-- Code 59949
(59949, 150, '19928'), (59949, 150, '3668'), (59949, 20, 'ISNA'), (59949, 212, '32717-1'),
(59949, 266, ''), (59949, 277, ''), (59949, 3, '32180'), (59949, 4, '32180'),
(59949, 6, 'CPMC Laboratory Test: Sodium Istat'), (59949, 9, 'ISNA'),

-- Additional codes...
(66253, 150, '19928'), (66253, 150, '3668'), (66253, 20, 'NAM'), (66253, 212, '2947-0'),
(66253, 266, ''), (66253, 277, ''), (66253, 3, '32180'), (66253, 4, '32180'),
(66253, 6, 'CPMC Laboratory Test: Sodium Whole Blood (2)'), (66253, 9, 'NAM'),

(66254, 150, '19928'), (66254, 150, '3668'), (66254, 20, 'NAMZ'), (66254, 212, '2947-0'),
(66254, 266, ''), (66254, 277, ''), (66254, 3, '32180'), (66254, 4, '32180'),
(66254, 6, 'CPMC Laboratory Test: Sodium Whole Blood (allen)'), (66254, 9, 'NAMZ'),

(100031, 150, '19928'), (100031, 150, '3668'), (100031, 212, '2951-2'), (100031, 264, '317298'),
(100031, 266, ''), (100031, 277, '29512'), (100031, 3, '32698'), (100031, 4, '32698'),
(100031, 6, 'BKR (CM) RESULT: SODIUM LEVEL'),

(111465, 150, '19928'), (111465, 150, '3668'), (111465, 212, '2947-0'), (111465, 264, '4272034'),
(111465, 266, ''), (111465, 277, '5658'), (111465, 3, '32180'), (111465, 4, '32180'),
(111465, 6, 'BKR (CM) Result: Sodium Whole Blood POC'),

(112423, 150, '19928'), (112423, 150, '3668'), (112423, 212, '2947-0'), (112423, 264, '4329535'),
(112423, 266, ''), (112423, 277, '29470'), (112423, 3, '32180'), (112423, 4, '32180'),
(112423, 6, 'BKR (CM) Result: Sodium WB'),

(125598, 150, '19928'), (125598, 150, '3668'), (125598, 212, '2947-0'), (125598, 264, '7853268'),
(125598, 266, ''), (125598, 277, '6484'), (125598, 3, '32180'), (125598, 4, '32180'),
(125598, 6, 'BKR (CM) Result: Sodium W/B - EPOC'),

(128428, 150, '19928'), (128428, 150, '3668'), (128428, 20, 'EPNA'), (128428, 212, ''),
(128428, 266, ''), (128428, 277, ''), (128428, 3, '32180'), (128428, 4, '32180'),
(128428, 6, 'CPMC Laboratory Test: Sodium Whole Blood POC'),

(129704, 150, '19928'), (129704, 150, '3668'), (129704, 212, '32717-1'), (129704, 264, '11682263'),
(129704, 266, ''), (129704, 277, '21027'), (129704, 3, '32180'), (129704, 4, '32180'),
(129704, 6, 'BKR (CM) Result: Sodium BGA'),

(129713, 150, '19928'), (129713, 150, '3668'), (129713, 212, '39791-9'), (129713, 264, '11682403'),
(129713, 266, ''), (129713, 277, '21035'), (129713, 3, '169652'), (129713, 3, '32180'),
(129713, 4, '169652'), (129713, 6, 'BKR (CM) Result: Sodium BGV'),

(133171, 150, '19928'), (133171, 150, '3668'), (133171, 212, '2947-0'), (133171, 264, '18710951'),
(133171, 266, ''), (133171, 277, '21189'), (133171, 3, '32180'), (133171, 4, '32180'),
(133171, 6, 'BKR (CM) Result: Sodium POC IL'),

(169623, 150, '19928'), (169623, 150, '3668'), (169623, 212, '2947-0'), (169623, 264, '72986158'),
(169623, 266, ''), (169623, 277, '22319'), (169623, 3, '169652'), (169623, 3, '32180'),
(169623, 4, '169652'), (169623, 6, 'Cerner ME DTA: Sodium POC'),

(169652, 150, '19928'), (169652, 150, '3668'), (169652, 212, ''), (169652, 266, ''),
(169652, 277, ''), (169652, 3, '32180'), (169652, 4, '32180'), (169652, 6, 'Venous Blood Sodium Tests'),

(170063, 150, '19928'), (170063, 150, '3668'), (170063, 212, '2951-2'), (170063, 266, ''),
(170063, 277, ''), (170063, 3, '32698'), (170063, 4, '32698'), (170063, 6, 'Meditech Result: SODIUM'),

(181985, 150, '19928'), (181985, 150, '3668'), (181985, 212, '2951-2'), (181985, 266, ''),
(181985, 277, ''), (181985, 3, '32698'), (181985, 4, '32698'),
(181985, 6, 'LabCorp Result: Sodium, Serum (1198)'),

(197005, 150, '19928'), (197005, 150, '3668'), (197005, 212, '2951-2'), (197005, 266, ''),
(197005, 277, ''), (197005, 3, '32698'), (197005, 4, '32698'),
(197005, 6, 'LabCorp Result: Sodium, Serum (132258)'),

(201232, 150, '19928'), (201232, 150, '3668'), (201232, 212, '2951-2'), (201232, 266, ''),
(201232, 277, ''), (201232, 3, '32698'), (201232, 4, '32698'),
(201232, 6, 'Meditech Order: Sodium (Retired)'),

(228458, 150, '19928'), (228458, 150, '3668'), (228458, 212, '2951-2'), (228458, 266, ''),
(228458, 277, ''), (228458, 3, '32698'), (228458, 4, '32698'), (228458, 6, 'Quest Result: SODIUM');

PRINT 'MED data loaded: ' + CAST(@@ROWCOUNT AS VARCHAR) + ' rows';
GO

-- ============================================================================
-- VERIFICATION
-- ============================================================================

PRINT '';
PRINT '============================================================================';
PRINT 'Database Setup Complete!';
PRINT '============================================================================';
PRINT 'MED_SLOTS rows: ' + CAST((SELECT COUNT(*) FROM MED_SLOTS) AS VARCHAR);
PRINT 'MED rows:       ' + CAST((SELECT COUNT(*) FROM MED) AS VARCHAR);
PRINT 'Unique codes:   ' + CAST((SELECT COUNT(DISTINCT CODE) FROM MED) AS VARCHAR);
PRINT '============================================================================';
GO
